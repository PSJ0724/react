name: Deploy to EC2

on:
  push:
    branches: [ master ]  # main 브랜치에 push될 때 실행
  workflow_dispatch:    # 수동 실행도 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 80
        script: |
          # 프로젝트 디렉토리로 이동
          cd /home/ubuntu/your-project-name
          
          # 최신 코드 가져오기
          git pull origin main
          
          # 의존성 설치 (package.json이 변경된 경우)
          npm install
          
          # 빌드가 필요한 경우
          npm run build
          
          # PM2로 앱 재시작 (PM2 사용 시)
          pm2 restart your-app-name || pm2 start npm --name "your-app-name" -- start
          
          # 또는 일반적인 재시작 (PM2 미사용 시)
          # pkill -f "node.*your-app"
          # nohup npm start > /dev/null 2>&1 &