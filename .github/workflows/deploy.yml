name: Deploy to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch:    # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 300s  # 5ë¶„ íƒ€ì„ì•„ì›ƒ
        command_timeout: 300s
        script: |
          echo "ğŸ” Starting deployment..."
          cd /home/ubuntu/react
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up existing processes..."
          pm2 delete app.js > /dev/null 2>&1 || true
          pkill -f "npm.*start" > /dev/null 2>&1 || true
          
          # Git ì•ˆì „ ë””ë ‰í† ë¦¬ ì„¤ì •
          git config --global --add safe.directory /home/ubuntu/react
          
          # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë¬´ì‹œí•˜ê³  ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          echo "ğŸ“¥ Fetching latest code..."
          git fetch origin master
          git reset --hard origin/master
          
          # ì˜ì¡´ì„± ì„¤ì¹˜ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
          echo "ğŸ“¦ Installing dependencies..."
          timeout 300 npm install || {
            echo "âŒ npm install failed or timed out"
            exit 1
          }
          
          # PM2ë¡œ ì•± ì‹œì‘
          echo "ğŸš€ Starting application..."
          pm2 start npm --name "my-app" -- start
          
          # ë°°í¬ ì™„ë£Œ í™•ì¸
          echo "ğŸ‰ Deployment completed!"
          pm2 status