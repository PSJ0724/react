name: Deploy to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch:    # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          cd /home/ubuntu/react
          
          # Git ì•ˆì „ ë””ë ‰í† ë¦¬ ì„¤ì • (í•œ ë²ˆë§Œ í•„ìš”)
          git config --global --add safe.directory /home/ubuntu/react
          
          # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë¬´ì‹œí•˜ê³  ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git fetch origin master
          git reset --hard origin/master
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          npm install
          
          # PM2ë¡œ ì•± ê´€ë¦¬ (ì¬ì‹œì‘ ë˜ëŠ” ì‹œì‘)
          if pm2 show my-app > /dev/null 2>&1; then
            echo "âœ… App is running, restarting..."
            pm2 restart my-app
          else
            echo "ğŸš€ App is not running, starting..."
            pm2 start npm --name "my-app" -- start
          fi
          
          # ë°°í¬ ì™„ë£Œ í™•ì¸
          echo "ğŸ‰ Deployment completed!"
          pm2 status